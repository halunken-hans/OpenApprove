generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum ProcessStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  REJECTED
}

enum ApprovalRule {
  ALL_APPROVE
  ANY_APPROVE
}

enum ParticipantRole {
  REVIEWER
  APPROVER
}

enum ParticipantStatus {
  PENDING
  APPROVED
  REJECTED
  REMOVED
  HANDED_OFF
}

enum DecisionType {
  APPROVE
  REJECT
}

enum AuditEventType {
  PROCESS_CREATED
  PROCESS_UPDATED
  FILE_UPLOADED
  FILE_VERSION_UPLOADED
  TOKEN_CREATED
  TOKEN_USED
  CYCLE_CONFIGURED
  CYCLE_STARTED
  DECISION_RECORDED
  REJECTION_RECORDED
  ANNOTATION_CREATED
  ANNOTATION_UPDATED
  ANNOTATION_DELETED
  EMAIL_SENT
  WEBHOOK_REGISTERED
  WEBHOOK_DELIVERED
  ROLE_CHANGED
  ACCESS_LOGGED
}

model Process {
  id               String          @id @default(cuid())
  projectNumber    String          @default("")
  customerNumber   String
  attributesJson   String          @default("{}")
  uploaderId       String
  uploaderCustomerNumber String?
  uploaderEmail    String?
  uploaderName     String?
  status           ProcessStatus   @default(DRAFT)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  files            File[]
  cycles           ApprovalCycle[]
  decisions        Decision[]
  auditEvents      AuditEvent[]

  @@index([projectNumber], map: "Process_projectNumber_idx")
  @@index([uploaderCustomerNumber], map: "Process_uploaderCustomerNumber_idx")
}

model File {
  id                         String        @id @default(cuid())
  processId                  String
  originalFilename           String        @default("")
  normalizedOriginalFilename String
  createdAt                  DateTime      @default(now())

  process                    Process       @relation(fields: [processId], references: [id], onDelete: Cascade)
  versions                   FileVersion[]

  @@index([processId], map: "File_processId_idx")
}

model FileVersion {
  id             String   @id @default(cuid())
  fileId         String
  versionNumber  Int
  sha256         String
  size           Int
  mime           String
  storagePath    String
  downloadSha256 String   @default("")
  downloadSize   Int      @default(0)
  downloadMime   String   @default("application/octet-stream")
  downloadStoragePath String @default("")
  viewSha256     String?
  viewSize       Int?
  viewMime       String?
  viewStoragePath String?
  approvalRequired Boolean @default(true)
  approvalRule   ApprovalRule @default(ALL_APPROVE)
  approvalPolicyJson String   @default("{}")
  uploadedByUploaderId String?
  uploadedByUploaderCustomerNumber String?
  uploadedByUploaderEmail String?
  uploadedByUploaderName String?
  attributesJson String   @default("{}")
  isCurrent      Boolean  @default(true)
  supersededAt   DateTime?
  supersededByVersionId String?
  createdAt      DateTime @default(now())

  file           File     @relation(fields: [fileId], references: [id], onDelete: Cascade)
  annotations    Annotation[]

  @@index([fileId], map: "FileVersion_fileId_idx")
}

model ApprovalCycle {
  id         String         @id @default(cuid())
  processId  String
  order      Int
  rule       ApprovalRule
  createdAt  DateTime       @default(now())

  process    Process        @relation(fields: [processId], references: [id], onDelete: Cascade)
  participants Participant[]
  decisions  Decision[]

  @@index([processId], map: "ApprovalCycle_processId_idx")
}

model Participant {
  id         String            @id @default(cuid())
  cycleId    String
  role       ParticipantRole
  status     ParticipantStatus @default(PENDING)
  displayName String?
  email      String?
  tokenId    String?
  createdAt  DateTime          @default(now())

  cycle      ApprovalCycle     @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  decisions  Decision[]
  annotations Annotation[]

  @@index([cycleId], map: "Participant_cycleId_idx")
}

model Decision {
  id            String       @id @default(cuid())
  processId     String
  cycleId       String
  participantId String
  fileVersionId String?
  decision      DecisionType
  reason        String?
  createdAt     DateTime     @default(now())

  process       Process      @relation(fields: [processId], references: [id], onDelete: Cascade)
  cycle         ApprovalCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)
  participant   Participant  @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@index([processId], map: "Decision_processId_idx")
}

model Token {
  id            String   @id @default(cuid())
  tokenHash     String   @unique(map: "sqlite_autoindex_Token_2")
  scopes        String
  expiry        DateTime
  oneTime       Boolean  @default(false)
  processId     String?
  participantId String?
  customerNumber String?
  uploaderId    String?
  roleAtTime    String?
  createdAt     DateTime @default(now())
  lastUsedAt    DateTime?

  @@index([expiry], map: "Token_expiry_idx")
}

model AuditEvent {
  id             String         @id @default(cuid())
  timestampUtc   DateTime       @default(now())
  eventType      AuditEventType
  processId      String?
  cycleId        String?
  fileId         String?
  fileVersionId  String?
  tokenId        String?
  roleAtTime     String?
  customerNumber String?
  uploaderId     String?
  ip             String?
  userAgent      String?
  validatedData  String
  prevHash       String
  eventHash      String

  process        Process?       @relation(fields: [processId], references: [id])

  @@index([processId], map: "AuditEvent_processId_idx")
}

model Annotation {
  id            String   @id @default(cuid())
  fileVersionId String
  participantId String?
  tokenId       String?
  dataJson      String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  fileVersion   FileVersion @relation(fields: [fileVersionId], references: [id], onDelete: Cascade)
  participant   Participant? @relation(fields: [participantId], references: [id])
}

model Webhook {
  id        String   @id @default(cuid())
  url       String
  secret    String
  events    String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  deliveries WebhookDelivery[]
}

model WebhookDelivery {
  id           String   @id @default(cuid())
  webhookId    String
  eventType    String
  payload      String
  signature    String
  status       String
  responseCode Int?
  error        String?
  createdAt    DateTime @default(now())
  deliveredAt  DateTime?

  webhook      Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
}
